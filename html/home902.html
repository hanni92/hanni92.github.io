<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart902 - è±èŒµèŠ±å›­902å®¤</title>
    <!-- å¼•å…¥jQuery -->
    <!-- <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> -->
	<script src="https://hanni92.github.io/../js/jquery-3.7.1.js"></script>
    <!-- å¼•å…¥MQTT.js -->
    <!-- <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script> -->
	<script src="https://hanni92.github.io/../js/mqtt.min.js"></script>
    <!-- å¼•å…¥Bootstrapç”¨äºå“åº”å¼è®¾è®¡ -->
    <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"> -->
	<link href="https://hanni92.github.io/../css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* æ ·å¼ä¿æŒä¸å˜ï¼Œä¸ä¹‹å‰ç›¸åŒ */
        :root {
            --primary-color: #3498db;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-on-color: #fff9c4;
            --light-off-color: #f5f5f5;
            --border-radius: 12px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background-color: #f8f9fa;
            color: #333;
            padding-bottom: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), #2980b9);
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        .connection-status {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-top: 10px;
            background-color: rgba(255,255,255,0.2);
        }
        
        .connected {
            background-color: rgba(46, 204, 113, 0.2);
        }
        
        .disconnected {
            background-color: rgba(231, 76, 60, 0.2);
        }
        
        .connecting {
            background-color: rgba(241, 196, 15, 0.2);
        }
        
        .lights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .lights-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .light-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            border: 1px solid #eaeaea;
        }
        
        .light-card.on {
            background-color: var(--light-on-color);
            border-color: #ffd54f;
        }
        
        .light-name {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
            display: flex;
            align-items: center;
        }
        
        .light-name:before {
            content: "ğŸ’¡";
            margin-right: 10px;
            font-size: 1.2rem;
        }
        
        .light-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .btn {
            flex: 1;
            padding: 12px 5px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-on {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-on:hover {
            background-color: #27ae60;
        }
        
        .btn-off {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-off:hover {
            background-color: #c0392b;
        }
        
        .light-status {
            font-size: 1rem;
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 6px;
            background-color: rgba(0,0,0,0.03);
        }
        
        .light-online-status {
            text-align: right;
            font-size: 0.9rem;
            padding: 5px;
        }
        
        .online {
            color: var(--success-color);
            font-weight: 600;
        }
        
        .offline {
            color: var(--danger-color);
            font-weight: 600;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 6px;
        }
        
        .online .status-indicator {
            background-color: var(--success-color);
            animation: pulse 2s infinite;
        }
        
        .offline .status-indicator {
            background-color: var(--danger-color);
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .heartbeat-info {
            font-size: 0.85rem;
            color: #95a5a6;
            margin-top: 5px;
            text-align: right;
        }
        
        .last-heartbeat {
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        
        .loading {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .reconnect-btn {
            margin-left: 10px;
            padding: 4px 12px;
            background-color: rgba(255,255,255,0.3);
            border: 1px solid white;
            color: white;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .reconnect-btn:hover {
            background-color: rgba(255,255,255,0.4);
        }
        
        .mqtt-info {
            margin-top: 5px;
            font-size: 0.8rem;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡µé¢å¤´éƒ¨ -->
        <div class="header">
            <h1 id="roomName">è±èŒµèŠ±å›­902å®¤</h1>
            <p>Smart902 <a href="https://hanni92.github.io/app-release.apk">ä¸‹è½½APP</a></p>
            <div id="connectionStatus" class="connection-status connecting">
                <span id="statusText">æ­£åœ¨è¿æ¥MQTTæœåŠ¡å™¨...</span>
                <button id="reconnectBtn" class="reconnect-btn" style="display:none;" onclick="manualReconnect()">é‡æ–°è¿æ¥</button>
            </div>
            <div id="mqttInfo" class="mqtt-info"></div>
        </div>
        
        <!-- ç¯å…‰æ§åˆ¶å¡ç‰‡å®¹å™¨ -->
        <div id="lightsContainer" class="lights-grid">
            <!-- ç¯å…‰å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            <div class="loading">
                æ­£åœ¨åŠ è½½è®¾å¤‡...
            </div>
        </div>
        
        <!-- é¡µé¢åº•éƒ¨ -->
        <div class="footer">
            <p>Smart902 &copy; 2026 | åŸºäºMQTTçš„å®æ—¶æ§åˆ¶</p>
        </div>
    </div>

    <script>
        // åˆå§‹æ•°æ®
        const roomName = "è±èŒµèŠ±å›­902å®¤";
        const dkNames = ["å®¢å…ç¯", "ä¸»å§ç¯", "æ¬¡å§ç¯"];
        const dkUids = ["500291E1D42D", "84F3EB35E156",  "500291ED7881"];
        
        // ============ ä¿®æ”¹ç‚¹1ï¼šä½¿ç”¨WSSè¿æ¥ ============
        // ä½¿ç”¨EMQXçš„WebSocket SSLè¿æ¥ï¼ˆæ›´ç¨³å®šï¼Œæµè§ˆå™¨å…¼å®¹æ€§å¥½ï¼‰
        const mqttBroker = "wss://broker.emqx.io:8084/mqtt";
        // å¤‡é€‰æœåŠ¡å™¨ï¼ˆå¦‚æœä¸Šé¢ä¸å¯ç”¨ï¼‰
        // const mqttBroker = "wss://test.mosquitto.org:8081";
        // const mqttBroker = "wss://mqtt.eclipseprojects.io:443/mqtt";
        
        const mqttTopic = "/ZC2023/device/GW000001/+/up";
        let mqttClient = null;
        let isConnected = false;
        let reconnectTimer = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 10;
        const RECONNECT_INTERVAL = 5000; // 5ç§’
        
        // å…¨å±€æ¶ˆæ¯IDï¼Œæ¯ä¸‹å‘ä¸€æ¬¡å‘½ä»¤åŠ 1
        let mid = 1;
        
        // è®¾å¤‡çŠ¶æ€å­˜å‚¨
        const devices = {};
        
        // åˆå§‹åŒ–è®¾å¤‡çŠ¶æ€
        function initializeDevices() {
            for (let i = 0; i < dkNames.length; i++) {
                devices[dkUids[i]] = {
                    name: dkNames[i],
                    uid: dkUids[i],
                    status: 'unknown', // 'on', 'off', 'unknown'
                    online: false,
                    lastHeartbeat: null,
                    heartbeatTimer: null,
                    lastHeartbeatTime: null
                };
            }
        }
        
        // è¿æ¥MQTTæœåŠ¡å™¨ï¼ˆä½¿ç”¨WSSï¼‰
        function connectMQTT() {
            console.log("æ­£åœ¨è¿æ¥MQTTæœåŠ¡å™¨:", mqttBroker);
            
            // æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
            updateConnectionStatus("æ­£åœ¨è¿æ¥MQTTæœåŠ¡å™¨...", "connecting");
            updateMqttInfo(`å°è¯•è¿æ¥: ${mqttBroker} (å°è¯• ${reconnectAttempts + 1}/${MAX_RECONNECT_ATTEMPTS})`);
            
            // å¦‚æœå·²æœ‰è¿æ¥ï¼Œå…ˆæ–­å¼€
            if (mqttClient && mqttClient.connected) {
                mqttClient.end();
            }
            
            // ============ ä¿®æ”¹ç‚¹2ï¼šä¼˜åŒ–è¿æ¥é€‰é¡¹ ============
            const options = {
                clientId: 'mqttjs_' + Math.random().toString(16).substr(2, 8),
                username: 'emqx', // å…¬å…±æœåŠ¡å™¨å¯èƒ½éœ€è¦
                password: 'public', // å…¬å…±æœåŠ¡å™¨å¯èƒ½éœ€è¦
                clean: true,
                reconnectPeriod: 0, // ç¦ç”¨è‡ªåŠ¨é‡è¿ï¼Œä½¿ç”¨æˆ‘ä»¬è‡ªå·±çš„é‡è¿é€»è¾‘
                connectTimeout: 10 * 1000, // 10ç§’è¿æ¥è¶…æ—¶
                keepalive: 30, // 30ç§’å¿ƒè·³
                protocolVersion: 4, // MQTT v3.1.1
                rejectUnauthorized: false // å¯¹äºè‡ªç­¾åè¯ä¹¦å¯èƒ½éœ€è¦
            };
            
            // å°è¯•è¿æ¥MQTT
            try {
                mqttClient = mqtt.connect(mqttBroker, options);
                setupMQTTListeners();
            } catch (error) {
                console.error("åˆ›å»ºMQTTå®¢æˆ·ç«¯å¤±è´¥:", error);
                handleConnectionError(error.message);
            }
        }
        
        // è®¾ç½®MQTTäº‹ä»¶ç›‘å¬å™¨
        function setupMQTTListeners() {
            // è¿æ¥æˆåŠŸ
            mqttClient.on('connect', function () {
                console.log("MQTTè¿æ¥æˆåŠŸ");
                isConnected = true;
                reconnectAttempts = 0;
                updateConnectionStatus("å·²è¿æ¥åˆ°æœåŠ¡å™¨", "connected");
                updateMqttInfo(``);
                
                // è®¢é˜…ä¸»é¢˜
                mqttClient.subscribe(mqttTopic, { qos: 0 }, function (err) {
                    if (!err) {
                        console.log("æˆåŠŸè®¢é˜…ä¸»é¢˜:", mqttTopic);
                    } else {
                        console.error("è®¢é˜…ä¸»é¢˜å¤±è´¥:", err);
                        updateMqttInfo(`è®¢é˜…å¤±è´¥: ${err.message}`);
                    }
                });
                
                // æ˜¾ç¤ºé‡æ–°è¿æ¥æŒ‰é’®
                $('#reconnectBtn').hide();
            });
            
            // æ¥æ”¶æ¶ˆæ¯å¤„ç†
            mqttClient.on('message', function (topic, message) {
                try {
                    const data = JSON.parse(message.toString());
                    console.log("æ”¶åˆ°æ¶ˆæ¯:", topic, data);
                    handleMQTTMessage(data);
                } catch (error) {
                    console.error("è§£ææ¶ˆæ¯å¤±è´¥:", error);
                }
            });
            
            // è¿æ¥æ–­å¼€å¤„ç†
            mqttClient.on('close', function () {
                console.log("æœåŠ¡å™¨è¿æ¥å·²æ–­å¼€");
                isConnected = false;
                updateConnectionStatus("æœåŠ¡å™¨è¿æ¥å·²æ–­å¼€", "disconnected");
                updateMqttInfo("è¿æ¥å·²æ–­å¼€ï¼Œæ­£åœ¨å°è¯•é‡æ–°è¿æ¥...");
                
                // æ˜¾ç¤ºé‡æ–°è¿æ¥æŒ‰é’®
                $('#reconnectBtn').show();
                
                // å°è¯•é‡æ–°è¿æ¥ï¼ˆæŒ‡æ•°é€€é¿ç­–ç•¥ï¼‰
                scheduleReconnect();
            });
            
            // è¿æ¥é”™è¯¯å¤„ç†
            mqttClient.on('error', function (error) {
                console.error("æœåŠ¡å™¨è¿æ¥é”™è¯¯:", error);
                isConnected = false;
                handleConnectionError(error.message);
            });
            
            // é‡è¿äº‹ä»¶
            mqttClient.on('reconnect', function () {
                console.log("æ­£åœ¨å°è¯•é‡æ–°è¿æ¥...");
                updateConnectionStatus("æ­£åœ¨é‡æ–°è¿æ¥...", "connecting");
            });
            
            // ç¦»çº¿äº‹ä»¶
            mqttClient.on('offline', function () {
                console.log("å®¢æˆ·ç«¯å·²ç¦»çº¿");
                isConnected = false;
                updateConnectionStatus("å®¢æˆ·ç«¯ç¦»çº¿", "disconnected");
            });
            
            // ç»“æŸäº‹ä»¶
            mqttClient.on('end', function () {
                console.log("MQTTè¿æ¥ç»“æŸ");
                isConnected = false;
            });
        }
        
        // å¤„ç†è¿æ¥é”™è¯¯
        function handleConnectionError(errorMessage) {
            updateConnectionStatus("è¿æ¥å¤±è´¥: " + errorMessage, "disconnected");
            updateMqttInfo(`è¿æ¥é”™è¯¯: ${errorMessage}`);
            
            // æ˜¾ç¤ºé‡æ–°è¿æ¥æŒ‰é’®
            $('#reconnectBtn').show();
            
            // å¦‚æœä¸æ˜¯ä¸»åŠ¨æ–­å¼€ï¼Œå°è¯•é‡æ–°è¿æ¥
            if (!mqttClient || !mqttClient.disconnecting) {
                scheduleReconnect();
            }
        }
        
        // è°ƒåº¦é‡æ–°è¿æ¥ï¼ˆæŒ‡æ•°é€€é¿ç­–ç•¥ï¼‰
        function scheduleReconnect() {
            // æ¸…é™¤ä¹‹å‰çš„é‡è¿å®šæ—¶å™¨
            if (reconnectTimer) {
                clearTimeout(reconnectTimer);
            }
            
            // æ£€æŸ¥æ˜¯å¦è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°
            if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
                updateConnectionStatus("è¿æ¥å¤±è´¥ï¼Œå·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°", "disconnected");
                updateMqttInfo("æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æœåŠ¡å™¨çŠ¶æ€");
                return;
            }
            
            // è®¡ç®—ä¸‹æ¬¡é‡è¿å»¶è¿Ÿï¼ˆæŒ‡æ•°é€€é¿ï¼‰
            const delay = Math.min(RECONNECT_INTERVAL * Math.pow(1.5, reconnectAttempts), 30000);
            reconnectAttempts++;
            
            console.log(`å°†åœ¨ ${delay/1000} ç§’åå°è¯•ç¬¬ ${reconnectAttempts} æ¬¡é‡è¿`);
            
            // è®¾ç½®é‡è¿å®šæ—¶å™¨
            reconnectTimer = setTimeout(function() {
                console.log(`æ‰§è¡Œç¬¬ ${reconnectAttempts} æ¬¡é‡è¿å°è¯•`);
                connectMQTT();
            }, delay);
            
            updateMqttInfo(`å°†åœ¨ ${Math.round(delay/1000)} ç§’åå°è¯•ç¬¬ ${reconnectAttempts} æ¬¡é‡è¿`);
        }
        
        // æ‰‹åŠ¨é‡æ–°è¿æ¥
        function manualReconnect() {
            console.log("æ‰‹åŠ¨é‡æ–°è¿æ¥");
            reconnectAttempts = 0;
            if (reconnectTimer) {
                clearTimeout(reconnectTimer);
                reconnectTimer = null;
            }
            connectMQTT();
        }
        
        // å¤„ç†MQTTæ¶ˆæ¯
        function handleMQTTMessage(data) {
            const uid = data.uid;
            const op = data.op;
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºå·²çŸ¥è®¾å¤‡
            if (!devices[uid]) {
                console.warn("æ”¶åˆ°æœªçŸ¥è®¾å¤‡æ¶ˆæ¯:", uid);
                return;
            }
            
            // æ›´æ–°è®¾å¤‡æœ€åå¿ƒè·³æ—¶é—´
            const now = new Date();
            devices[uid].lastHeartbeat = now;
            devices[uid].lastHeartbeatTime = now.getTime();
            
            // æ¸…é™¤ä¹‹å‰çš„å¿ƒè·³è¶…æ—¶å®šæ—¶å™¨
            if (devices[uid].heartbeatTimer) {
                clearTimeout(devices[uid].heartbeatTimer);
            }
            
            // è®¾ç½®æ–°çš„å¿ƒè·³è¶…æ—¶å®šæ—¶å™¨ï¼ˆ10ç§’ï¼‰
            devices[uid].heartbeatTimer = setTimeout(function() {
                updateDeviceOnlineStatus(uid, false);
            }, 10000);
            
            // æ›´æ–°è®¾å¤‡åœ¨çº¿çŠ¶æ€
            updateDeviceOnlineStatus(uid, true);
            
            // å¤„ç†æ“ä½œç±»å‹
            if (op === 3) {
                // å¿ƒè·³æ¶ˆæ¯ï¼Œæ›´æ–°è®¾å¤‡çŠ¶æ€
                const p2 = data.data?.p2;
                if (p2 !== undefined) {
                    const status = p2 === 1 ? 'on' : 'off';
                    updateDeviceStatus(uid, status);
                }
            } else if (op === 5) {
                // æ§åˆ¶å“åº”æ¶ˆæ¯
                console.log("æ”¶åˆ°æ§åˆ¶å“åº”:", data);
            }
        }
        
        // æ›´æ–°è®¾å¤‡çŠ¶æ€
        function updateDeviceStatus(uid, status) {
            if (devices[uid]) {
                devices[uid].status = status;
                updateDeviceCard(uid);
            }
        }
        
        // æ›´æ–°è®¾å¤‡åœ¨çº¿çŠ¶æ€
        function updateDeviceOnlineStatus(uid, isOnline) {
            if (devices[uid]) {
                devices[uid].online = isOnline;
                
                // å¦‚æœè®¾å¤‡ç¦»çº¿ï¼ŒçŠ¶æ€è®¾ä¸ºunknown
                if (!isOnline) {
                    devices[uid].status = 'unknown';
                }
                
                updateDeviceCard(uid);
            }
        }
        
        // å‘é€æ§åˆ¶å‘½ä»¤
        function sendControlCommand(uid, turnOn) {
            if (!isConnected) {
                alert("MQTTè¿æ¥æœªå°±ç»ªï¼Œè¯·æ£€æŸ¥è¿æ¥çŠ¶æ€");
                return;
            }
            
            const command = {
                mid: mid++,
                op: 5,
                uid: uid,
                data: {
                    p0: turnOn ? 1 : 0,
                    p2: turnOn ? 1 : 0,
                    p3: turnOn ? 1 : 0
                }
            };
            
            console.log("å‘é€æ§åˆ¶å‘½ä»¤:", command);
            
            // å‘å¸ƒæ§åˆ¶å‘½ä»¤åˆ°å¯¹åº”ä¸»é¢˜
            const controlTopic = `/ZC2023/device/GW000001/${uid}/down`;
            mqttClient.publish(controlTopic, JSON.stringify(command), { qos: 0 }, function(err) {
                if (err) {
                    console.error("å‘é€æ§åˆ¶å‘½ä»¤å¤±è´¥:", err);
                    alert("å‘é€æ§åˆ¶å‘½ä»¤å¤±è´¥ï¼Œè¯·é‡è¯•");
                } else {
                    console.log("æ§åˆ¶å‘½ä»¤å·²å‘é€");
                    // æš‚æ—¶æ›´æ–°æœ¬åœ°çŠ¶æ€ï¼Œç­‰å¾…è®¾å¤‡ç¡®è®¤
                    devices[uid].status = turnOn ? 'on' : 'off';
                    updateDeviceCard(uid);
                }
            });
        }
        
        // æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
        function updateConnectionStatus(text, statusClass) {
            const statusText = $('#statusText');
            statusText.text(text);
            
            const statusElement = $('#connectionStatus');
            statusElement.removeClass('connected disconnected connecting');
            statusElement.addClass(statusClass);
        }
        
        // æ›´æ–°MQTTä¿¡æ¯æ˜¾ç¤º
        function updateMqttInfo(text) {
            $('#mqttInfo').text(text);
        }
        
        // åˆ›å»ºè®¾å¤‡å¡ç‰‡
        function createDeviceCards() {
            const container = $('#lightsContainer');
            container.empty();
            
            for (let i = 0; i < dkNames.length; i++) {
                const uid = dkUids[i];
                const device = devices[uid];
                
                const cardClass = device.status === 'on' ? 'light-card on' : 'light-card';
                const statusText = device.status === 'on' ? 'å¼€ç¯' : 
                                 device.status === 'off' ? 'å…³ç¯' : 'çŠ¶æ€æœªçŸ¥';
                const onlineStatus = device.online ? 'åœ¨çº¿' : 'ä¸åœ¨çº¿';
                const onlineClass = device.online ? 'online' : 'offline';
                
                const cardHtml = `
                    <div class="${cardClass}" id="card-${uid}">
                        <div class="light-name">${device.name}</div>
                        <div class="light-controls">
                            <button class="btn btn-on" onclick="controlLight('${uid}', true)" ${!device.online ? 'disabled' : ''}>
                                å¼€ç¯
                            </button>
                            <button class="btn btn-off" onclick="controlLight('${uid}', false)" ${!device.online ? 'disabled' : ''}>
                                å…³ç¯
                            </button>
                        </div>
                        <div class="light-status">å½“å‰çŠ¶æ€ï¼š${statusText}</div>
                        <div class="light-online-status ${onlineClass}">
                            <span class="status-indicator"></span>${onlineStatus}
                        </div>
                        ${device.lastHeartbeat ? `
                            <div class="heartbeat-info">
                                æœ€åå¿ƒè·³: <span class="last-heartbeat">${formatTime(device.lastHeartbeat)}</span>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                container.append(cardHtml);
            }
        }
        
        // æ›´æ–°è®¾å¤‡å¡ç‰‡
        function updateDeviceCard(uid) {
            const device = devices[uid];
            if (!device) return;
            
            const cardElement = $(`#card-${uid}`);
            if (cardElement.length === 0) return;
            
            // æ›´æ–°å¡ç‰‡æ ·å¼
            if (device.status === 'on') {
                cardElement.addClass('on');
            } else {
                cardElement.removeClass('on');
            }
            
            // æ›´æ–°çŠ¶æ€æ–‡æœ¬
            const statusText = device.status === 'on' ? 'å¼€ç¯' : 
                             device.status === 'off' ? 'å…³ç¯' : 'çŠ¶æ€æœªçŸ¥';
            cardElement.find('.light-status').text(`å½“å‰çŠ¶æ€ï¼š${statusText}`);
            
            // æ›´æ–°åœ¨çº¿çŠ¶æ€
            const onlineStatus = device.online ? 'åœ¨çº¿' : 'ä¸åœ¨çº¿';
            const onlineClass = device.online ? 'online' : 'offline';
            const onlineElement = cardElement.find('.light-online-status');
            onlineElement.html(`<span class="status-indicator"></span>${onlineStatus}`)
                        .removeClass('online offline').addClass(onlineClass);
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            cardElement.find('.btn-on, .btn-off').prop('disabled', !device.online);
            
            // æ›´æ–°æœ€åå¿ƒè·³æ—¶é—´
            if (device.lastHeartbeat) {
                let heartbeatElement = cardElement.find('.heartbeat-info');
                if (heartbeatElement.length === 0) {
                    cardElement.append(`
                        <div class="heartbeat-info">
                            æœ€åå¿ƒè·³: <span class="last-heartbeat">${formatTime(device.lastHeartbeat)}</span>
                        </div>
                    `);
                } else {
                    heartbeatElement.find('.last-heartbeat').text(formatTime(device.lastHeartbeat));
                }
            }
        }
        
        // æ§åˆ¶ç¯å…‰
        function controlLight(uid, turnOn) {
            sendControlCommand(uid, turnOn);
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(date) {
            if (!date) return 'ä»æœª';
            
            const now = new Date();
            const diff = Math.floor((now - date) / 1000); // ç§’æ•°å·®
            
            if (diff < 60) {
                return `${diff}ç§’å‰`;
            } else if (diff < 3600) {
                return `${Math.floor(diff / 60)}åˆ†é’Ÿå‰`;
            } else {
                return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        $(document).ready(function() {
            // åˆå§‹åŒ–è®¾å¤‡æ•°æ®
            initializeDevices();
            
            // è®¾ç½®æˆ¿é—´åç§°
            $('#roomName').text(roomName);
            
            // æ›´æ–°æœåŠ¡å™¨ä¿¡æ¯æ˜¾ç¤º
            $('#serverInfo').text(`è¿æ¥æœåŠ¡å™¨: ${mqttBroker} | ä¸»é¢˜: ${mqttTopic}`);
            
            // åˆ›å»ºè®¾å¤‡å¡ç‰‡
            createDeviceCards();
            
            // è¿æ¥MQTTæœåŠ¡å™¨
            connectMQTT();
            
            // æ¨¡æ‹Ÿè®¾å¤‡å¿ƒè·³ï¼ˆç”¨äºæ¼”ç¤ºï¼‰
			/*
            setTimeout(function() {
                // æ¨¡æ‹Ÿéƒ¨åˆ†è®¾å¤‡å¿ƒè·³
                simulateHeartbeat("84F3EB35E156", 1); // ä¸»å§ç¯å¼€
                simulateHeartbeat("84F3EB35E157", 0); // å®¢å…ç¯å…³
                simulateHeartbeat("84F3EB35E158", 1); // æ¬¡å§ç¯å¼€
            }, 2000);*/
            
            // å®šæœŸæ£€æŸ¥è®¾å¤‡åœ¨çº¿çŠ¶æ€
            setInterval(function() {
                const now = new Date().getTime();
                for (const uid in devices) {
                    const device = devices[uid];
                    if (device.lastHeartbeatTime) {
                        const diff = now - device.lastHeartbeatTime;
                        if (diff > 10000 && device.online) {
                            updateDeviceOnlineStatus(uid, false);
                        }
                    }
                }
            }, 3000);
        });
        
        // æ¨¡æ‹Ÿè®¾å¤‡å¿ƒè·³ï¼ˆä»…ç”¨äºæ¼”ç¤ºï¼Œå®é™…ç¯å¢ƒä¸­è®¾å¤‡ä¼šè‡ªåŠ¨å‘é€ï¼‰
		/*
        function simulateHeartbeat(uid, p2Value) {
            if (!devices[uid]) return;
            
            const heartbeat = {
                op: 3,
                uid: uid,
                data: {
                    p0: 0,
                    p2: p2Value,
                    p3: 0
                }
            };
            
            // æ¨¡æ‹ŸMQTTæ¶ˆæ¯åˆ°è¾¾
            setTimeout(function() {
                handleMQTTMessage(heartbeat);
                
                // å®šæœŸæ¨¡æ‹Ÿå¿ƒè·³
                if (devices[uid] && devices[uid].online) {
                    setTimeout(function() {
                        simulateHeartbeat(uid, p2Value);
                    }, 8000); // 8ç§’åå†æ¬¡æ¨¡æ‹Ÿå¿ƒè·³
                }
            }, 100);
        }*/
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        $(window).on('beforeunload', function() {
            if (mqttClient) {
                mqttClient.end();
            }
            if (reconnectTimer) {
                clearTimeout(reconnectTimer);
            }
        });
    </script>
</body>

</html>


